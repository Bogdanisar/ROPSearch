<?xml version="1.0"?>
<!--
This is a configuration file used for building Gadget Moulds at run-time.
Note: This gadget catalog configuration uses Instruction Sequences
      that correspond to those that we have in "hardcodedGadgets64bit.c" / "vulnerableHelped.exe"
-->
<catalog>
    <!--
        Each gadget could be expressed in different ways,
        according to what instruction sequences are available.
        Each "variant" is one such valid instantiation. Each gadget needs at least one variant.
    -->

    <gadget name="AssignConstant">
        <!--
            RAX - Address of memory location (variable)
            RBX - Constant value
         -->
        <variant>
            <stack stack-top="last">
                <!-- 'size' is the number of bytes -->
                <arg name="const" size="8"></arg>
                <arg name="dest" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    pop %rbx;
                    mov %rbx, (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="AssignVarToVar">
        <!--
            RAX - address of first memory location (variable)
            RBX - address of second memory location (variable)
            *RBX <- *RAX
        -->
        <variant>
            <stack stack-top="last">
                <arg name="dest" size="8"></arg>
                <arg name="src" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    pop %rbx;
                    mov (%rax), %rax;
                    mov %rax, (%rbx);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="storePointerDereferenceIntoVariable">
        <!--
            RAX - address of first memory location (pointer variable)
            RBX - address of second memory location (variable)
            *RBX <- **RAX (i.e. Variable1 <- *Variable2)
         -->
        <variant>
            <stack stack-top="last">
                <arg name="dest" size="8"></arg>
                <arg name="ptrSource" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    pop %rbx;
                    mov (%rax), %rax;
                    mov (%rax), %rax;
                    mov %rax, (%rbx);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="storeVariableIntoPointerDereference">
        <!--
            RAX - address of first memory location (pointer variable)
            RBX - address of second memory location (variable)
            **RAX <- *RBX (i.e. *Variable1 <- Variable2)
         -->
        <variant>
            <stack stack-top="last">
                <arg name="src" size="8"></arg>
                <arg name="ptrDest" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    pop %rbx;
                    mov (%rax), %rax;
                    mov (%rbx), %rbx;
                    mov %rbx, (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="negateValueOfVariable">
        <!--
            RAX - address of memory location (variable)
            RBX - working register
         -->
        <variant>
            <stack stack-top="last">
                <arg name="var" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    mov (%rax), %rbx;
                    neg %rbx;
                    mov %rbx, (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>

        <!--
            RAX - address of memory location (variable)
            RBX - working register
            RCX - 0
            *RAX <- (0 - *RAX)
         -->
        <variant>
            <stack stack-top="last">
                <arg name="var" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    mov (%rax), %rbx;
                    xor %rcx, %rcx;
                    sub %rbx, %rcx;
                    mov %rcx, (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="incrementVariable">
        <variant>
            <stack stack-top="last">
                <arg name="var" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    incq (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
    <gadget name="decrementVariable">
        <variant>
            <stack stack-top="last">
                <arg name="var" size="8"></arg>
                <insSeq syntax="att">
                    pop %rax;
                    decq (%rax);
                    ret;
                </insSeq>
            </stack>
        </variant>
    </gadget>
</catalog>